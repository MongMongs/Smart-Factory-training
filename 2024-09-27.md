
## - 단계 1. Phi 보드가 온습도 정보를 MQTT를 통해 Broker에 Publish
파일 이름 : Phi_Publish_DHT11_modified.ino
```
#include <WiFi.h>
#include <PubSubClient.h>
#include "DHT.h"

#define DHTPIN D2
#define DHTTYPE DHT11  
#define PAYLOADSIZE 100  // Define an appropriate payload size

DHT dht(DHTPIN, DHTTYPE);

const char* ssid = "pcroom";
const char* password = "12345678";

const char* clientId = "mqtt_juj";
const char* userId = clientId;
const char* userPw = "1234";
char *topic_t = "Sensors/MyOffice/Indoor/temp";
char *topic_h = "Sensors/MyOffice/Indoor/humi";
;
const char* server = "192.168.0.23"; 

WiFiClient wifiClient; 
PubSubClient client(server, 1883, wifiClient);

void setup() {
  Serial.begin(9600);
 
  Serial.print("\nConnecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println("\nWiFi Connected");
  
  Serial.println("Connecting to broker");
  while ( !client.connect(clientId, userId, userPw) ){ 
    Serial.print("*");
    delay(1000);
  }
  Serial.println("\nConnected to broker");
  dht.begin();
}

void loop() {
  char buf[20];
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  if (isnan(h) || isnan(t) ) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  String str = String(h);
  str.toCharArray(buf, str.length());
  client.publish(topic_h, buf);
  Serial.println(String(topic_h) + " : " + buf);
  
  str = String(t);
  str.toCharArray(buf, str.length());
  client.publish(topic_t, buf);
  Serial.println(String(topic_t)  + " : " + buf);
  delay(2000);
}
```
 - 결과 출력

![image](https://github.com/user-attachments/assets/4752c2d7-f303-4151-9f58-14684d3d27a4)

## - 단계 3. 온습도 정보를 구독하는 프로그램이 InfluxDB에 온습도 정보 넣음![image](https://github.com/user-attachments/assets/66d9d25a-17a5-45b1-9351-fb4cadc2d98c)
- 파일 명 : SubHumiTempInsetMod.py
```
from influxdb import InfluxDBClient  # file name : SubHumiTempInsetMod.py
import paho.mqtt.client as mqtt

dbClient = InfluxDBClient(host='localhost', port=8086, username='mqtt_imyme', password='1234',
                          database='db_riatech')


def on_connect(client, userdata, flags, rc):
    print("Connect with result code " + str(rc))
    client.subscribe("Sensors/MyOffice/#")


def on_message(client, userdata, msg):
    print(msg.topic + " " + str(msg.payload))
    # msg.topic -> 'Sensors/MyOffice/Indoor/SensorValue'
    topic = msg.topic.split('/')
    loc = topic[1]
    subloc = topic[2]
    # msg.payload -> "{'Temp' : 23.1, 'Humi': 33.3}"
    payload = eval(msg.payload)

    json_body = []
    data_point = {
        'measurement': 'Sensors',
        'tags': {'Location': '', 'SubLocation': ''},
        'fields': {'Temp': 0.0, 'Humi': 0.0}
    }
    data_point['tags']['Location'] = loc
    data_point['tags']['SubLocation'] = subloc
    data_point['fields']['Temp'] = payload['Temp']
    data_point['fields']['Humi'] = payload['Humi']
    json_body.append(data_point)
    dbClient.write_points(json_body)


client = mqtt.Client()
client.username_pw_set(username="mqtt_riatech", password="1234")
client.on_connect = on_connect
client.on_message = on_message
client.connect("localhost", 1883, 60)
client.loop_forever()
```

![image](https://github.com/user-attachments/assets/4d487324-2589-4429-a810-d8db5fee8c88)
